<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoVoice | Raw Share</title>
    <!-- PeerJS Library (Free Cloud Signaling) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* NEO-BRUTALISM CSS */
        :root {
            --bg-color: #ffeaa7;
            --card-bg: #ffffff;
            --border-color: #000000;
            --main-color: #74b9ff; /* Blue */
            --accent-color: #ff7675; /* Red */
            --success-color: #55efc4; /* Green */
            --shadow: 5px 5px 0px 0px #000000;
            --border: 3px solid #000000;
        }

        body {
            font-family: 'Courier New', Courier, monospace; /* Raw Font */
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            background: var(--main-color);
            border: var(--border);
            box-shadow: var(--shadow);
            padding: 10px 20px;
            text-transform: uppercase;
            font-weight: 900;
            font-size: 2rem;
            transform: rotate(-1deg);
            margin-bottom: 30px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border: var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        /* INPUT AREA */
        .controls-top {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input {
            flex: 1;
            padding: 15px;
            border: var(--border);
            font-weight: bold;
            font-family: inherit;
            outline: none;
            background: #f1f2f6;
            min-width: 200px;
        }

        input:focus {
            background: #dfe6e9;
        }

        /* BUTTONS */
        button {
            padding: 15px 25px;
            border: var(--border);
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.1s;
            font-family: inherit;
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px 0px #000000;
        }

        .btn-connect { background-color: var(--success-color); }
        .btn-mute { background-color: #fab1a0; }
        .btn-screen { background-color: var(--main-color); }
        .btn-end { background-color: var(--accent-color); color: white; }

        .active-state {
            border-style: dashed;
            opacity: 0.7;
        }

        /* VIDEO GRID */
        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            position: relative;
        }

        .video-wrapper {
            background: #000;
            border: var(--border);
            box-shadow: var(--shadow);
            aspect-ratio: 16/9;
            position: relative;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* LABELS */
        .label {
            position: absolute;
            top: 0;
            left: 0;
            background: #000;
            color: #fff;
            padding: 5px 10px;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 10;
        }

        /* Small Local Video Picture-in-Picture style */
        #local-wrapper {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            aspect-ratio: 16/9;
            z-index: 20;
            border: 2px solid #fff;
        }

        /* ACTION BAR */
        .action-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        /* UTILS */
        .status {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
    </style>
</head>
<body>

    <h1>Neo<span style="color:white">Chat</span></h1>

    <div class="container">
        
        <!-- ID PANEL -->
        <div class="card">
            <div class="status" id="status-text">Initializing High Quality Audio...</div>
            <div class="controls-top">
                <input type="text" id="my-id" readonly placeholder="Waiting for ID..." onclick="this.select()">
                <input type="text" id="partner-id" placeholder="Paste Partner ID here">
                <button class="btn-connect" id="btn-connect">Connect</button>
            </div>
        </div>

        <!-- VIDEO AREA -->
        <div class="video-grid">
            <!-- Remote Video (Big) -->
            <div class="video-wrapper">
                <div class="label">REMOTE FEED</div>
                <video id="remote-video" autoplay playsinline></video>
            </div>
            
            <!-- Local Video (Small Overlay) -->
            <div class="video-wrapper" id="local-wrapper">
                <div class="label">YOU</div>
                <video id="local-video" autoplay playsinline muted></video>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="action-bar">
            <button class="btn-mute" id="btn-mute">Mute Mic</button>
            <button class="btn-screen" id="btn-screen">Share Screen</button>
            <button class="btn-end" onclick="location.reload()">End</button>
        </div>

    </div>

    <script>
        // === 1. CONFIGURATION & HIGH QUALITY AUDIO ===
        const peer = new Peer(); // Auto-generates ID from PeerJS cloud
        
        // Isse call quality achi hogi
        const constraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            },
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "user"
            }
        };

        // === 2. VARIABLES ===
        let localStream;
        let remoteStream;
        let currentCall;
        let screenStream;
        let isMuted = false;
        let isSharing = false;
        let camTrack; // To store camera video track when switching to screen

        // Elements
        const myIdIn = document.getElementById('my-id');
        const partnerIdIn = document.getElementById('partner-id');
        const btnConnect = document.getElementById('btn-connect');
        const localVid = document.getElementById('local-video');
        const remoteVid = document.getElementById('remote-video');
        const statusText = document.getElementById('status-text');

        // === 3. INITIALIZATION ===
        async function startApp() {
            try {
                // Get Camera & Mic
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVid.srcObject = localStream;
                
                // Store camera track for later
                camTrack = localStream.getVideoTracks()[0];

                statusText.innerText = "Ready. Share your ID.";
                statusText.style.color = "green";

                // Setup Peer Events
                peer.on('open', (id) => {
                    myIdIn.value = id;
                    console.log("My ID: " + id);
                });

                // Incoming Call Handler
                peer.on('call', (call) => {
                    // Auto answer or confirm
                    if(confirm("Incoming call... Accept?")) {
                        call.answer(localStream);
                        handleCall(call);
                    }
                });

                peer.on('error', (err) => {
                    console.error(err);
                    alert("Connection Error: " + err.type);
                });

            } catch (err) {
                statusText.innerText = "Error accessing Media Devices!";
                alert("Please allow Camera and Microphone permissions.");
            }
        }

        // === 4. CALL LOGIC ===
        btnConnect.addEventListener('click', () => {
            const pid = partnerIdIn.value;
            if(!pid) return alert("Enter Partner ID");
            statusText.innerText = "Connecting...";
            
            const call = peer.call(pid, localStream);
            handleCall(call);
        });

        function handleCall(call) {
            currentCall = call;
            
            call.on('stream', (stream) => {
                remoteVid.srcObject = stream;
                statusText.innerText = "Connected Securely.";
                document.body.style.backgroundColor = "#dff9fb"; // Slight color change on connect
            });

            call.on('close', () => {
                alert("Call Ended");
                location.reload();
            });
        }

        // === 5. FEATURES: MUTE & SCREEN SHARE ===

        // Mute Toggle
        document.getElementById('btn-mute').addEventListener('click', function() {
            if(!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            
            isMuted = !isMuted;
            audioTrack.enabled = !isMuted;

            this.innerText = isMuted ? "Unmute" : "Mute Mic";
            this.style.background = isMuted ? "#ff7675" : "#fab1a0"; // Red when muted
        });

        // Screen Share Logic
        document.getElementById('btn-screen').addEventListener('click', async function() {
            if(!currentCall) return alert("Call connect hone ke baad screen share karein.");

            if(!isSharing) {
                // START SHARING
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: true, 
                        audio: true // System audio bhi share karega
                    });
                    
                    const screenTrack = screenStream.getVideoTracks()[0];

                    // Handle "Stop Sharing" from browser popup
                    screenTrack.onended = () => stopScreenShare();

                    // Replace Camera Track with Screen Track (Magic happens here)
                    const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    
                    if(sender) {
                        await sender.replaceTrack(screenTrack);
                        localVid.srcObject = screenStream; // Show own screen in preview
                        
                        isSharing = true;
                        this.innerText = "Stop Sharing";
                        this.classList.add('active-state');
                    }
                } catch(err) {
                    console.error("Screen share cancel hua", err);
                }
            } else {
                // STOP SHARING manually
                stopScreenShare();
            }
        });

        function stopScreenShare() {
            const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            
            // Revert to Camera
            if(sender && camTrack) {
                sender.replaceTrack(camTrack);
            }

            // Clean up screen tracks
            if(screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }

            localVid.srcObject = localStream; // Show camera again
            isSharing = false;
            
            const btn = document.getElementById('btn-screen');
            btn.innerText = "Share Screen";
            btn.classList.remove('active-state');
        }

        // Start Everything
        startApp();

    </script>
</body>
</html>
